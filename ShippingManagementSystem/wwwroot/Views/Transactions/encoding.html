<div id="waybillList">
   <div class="container">
       <div class="card">
           <div class="card-content">
               <div class="row" style="color: black;">
                   <input type="text" placeholder="Search (e.g. Names, Dates)" onkeyup="filterToTbl(this,'tbl_waybillList')" />
               </div>
               <div class="row">
                   <table id="tbl_waybillList" class="highlight">
                       <thead>
                           <tr>
                               <th>
                                   Date
                               </th>
                               <th>
                                   Route
                               </th>
                               <th>
                                   Tracking No.
                               </th>
                               <th>
                                   Waybill No.
                               </th>
                               <th>
                                   Shipper
                               </th>
                               <th>
                                   Consignee
                               </th>
                           </tr>
                       </thead>
                       <tbody>
                           

                       </tbody>
                   </table>
               </div>
           </div>
       </div>
       
   </div>
</div>

<div id="waybillForm" style="display:none; color:white;">
    <div class="container">
        <div class="card blue-grey darken-1">
            <div class="card-content white-text" style="font-size: smaller; color: white;">
                <div class="row">
                    <div class="col s12 m4 l4">
                       
                            <label style="color:white;">Tracking No.: </label>
                            <input class="materialize" type="text" id="trackingno" disabled>
                     
                    </div>
                    <div class="col s12 m2 l2">
                        <label style="color:white;">Date: </label>
                        <input class="materialize" data-toggle="datepicker" disabled id="createDate">
                    </div>
                    <div class="col s12 m2 l2">
                       
                            <label style="color:white;">Route: </label>
                            <input class="materialize" type="text" disabled id="route">
                           
                       
                    </div>
                    <div class="col s12 m2 l2">
                        <label style="color:white;">Pickup Date: </label>
                        <input class="materialize" data-toggle="datepicker" id="pickupDate">
                    </div>
                    <div class="col s12 m2 l2">
                        <label style="color:white;">Delivered Date: </label>
                        <input class="materialize" data-toggle="datepicker" id="deliveredDate">
                    </div>
                </div>
                <div class="row">
                    
                    <div class="col s12 m4 l4">
                        <label for="trackingno" style="color: white;">Waybill No.</label>
                            <input id="waybillno" type="text" class="validate">
                           
                    </div>
                    <div class="col s12 m4 l4">
                            <label for="trackingno" style="color: white;">PR No.</label>
                            <input id="prno" type="text" class="validate">
                           
                    </div>
                    <div class="col s12 m4 l4">
                        <u>Rates: </u><br/>
                        &nbsp;Volume: <br/>
                        &nbsp;Weight: <br />
                        &nbsp;Value: <br />
                        &nbsp;Minimum: <br />

                    </div>
                </div>
                
                <div class="row">
                    <div class="col s12 m6 l6">
                        Shipper: 
                        <br/><strong><u id="shipperName"></u></strong>
                        <div>
                            Phone: <br/><i id="shipperPhone"></i> <br/>
                            Address:<i id="shipperAddress"></i>
                        </div>
                    </div>
                    <div class="col s12 m6 l6">
                        Consignee:<br /><strong><u id="consigneeName"></u></strong>
                        <div>
                            Phone: <br /><i id="consigneePhone"></i><br />
                            Address:<i id="consigneeAddress"></i>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m3 l3">
                        Pickup Charge: 
                        <div class="input-field inline">
                            <input id="pickupCharge" type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;" >
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Delivery Charge:
                        <div class="input-field inline">
                            <input id="deliveryCharge"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Weight Charge:
                        <div class="input-field inline">
                            <input id="weightCharge"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Volume Charge:
                        <div class="input-field inline">
                            <input id="volumeCharge"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m3 l3">
                        Value Charge:
                        <div class="input-field inline">
                            <input id="valueCharge"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Adjustment
                        <div class="input-field inline">
                            <input id="adjustment"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Discount:
                        <div class="input-field inline">
                            <input id="discount"  type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                    <div class="col s12 m3 l3">
                        Flat Rate Charge:
                        <div class="input-field inline">
                            <input id="flatrateCharge" type="number" class="validate" placeholder="0.00" style="width: 90px; text-align: right;">
                        </div>
                    </div>
                </div>
                <div class="row">
                    
                </div>
                <div class="row" style="background-color:white; color: black;">
                    <div class="s12 m12 l12">
                        <table class="highlight" style="font-size:smaller;" cellpadding="1" id="summaryTbl">
                            <thead>
                                <tr>
                                    <th onclick="$('#itemSummaryForm').modal('open')">
                                        <span class="new badge left" style="margin:0" data-badge-caption="New"></span>
                                    </th>
                                    <th>
                                        Item Range
                                    </th>
                                    <th>
                                        Unit
                                    </th>
                                    <th>
                                        Description
                                    </th>
                                    <th>
                                        Weight
                                    </th>
                                    <th>
                                        Length
                                    </th>
                                    <th>
                                        Width
                                    </th>
                                    <th>
                                        Height
                                    </th>
                                    <th>
                                        Vol
                                    </th>
                                    <th>
                                        Value
                                    </th>
                                    <th>
                                        Flat Rate
                                    </th>
                                    <th>
                                        Charges
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card-action">
                <button class="btn teal" onclick="savewaybill();">
                    Save
                </button>
            </div>
        </div>
    </div>
    
</div>

<div id="itemSummaryForm" style="color: black;" class="modal">
        <div class="container" style="background:none;">
            <div class="card">
                <div class="title">

                </div>
                <div class="card-content">
                    <div class="row">
                        <div class="col s12 mm4 l4">
                            <label>
                                Item No. Start
                            </label>
                            <input type="text" id="itemRangeStart" />
                        </div>
                        <div class="col s12 mm4 l4">
                            <label>
                                Item No. End
                            </label>
                            <input type="text" id="itemRangeEnd" />
                        </div>
                        <div class="col s12 mm4 l4">
                            <label>
                               Unit
                            </label>
                            <select id="itemUnit">
                                <option value="" disabled selected>Choose your option</option>
                                <option value="Box">Box</option>
                                <option value="Barrel">Barrel</option>
                                <option value="Bottle">Bottle</option>
                            </select>

                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m4 l4">
                            <label >
                                Length
                            </label>
                            <input type="text" id="itemLength" />
                        </div>
                        <div class="col s12 m4 l4">
                            <label>
                                Width
                            </label>
                            <input type="text" id="itemWidth" />
                        </div>
                        <div class="col s12 m4 l4">
                            <label>
                                Height
                            </label>
                            <input type="text" id="itemHeight" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m4 l4">
                            <label>
                                Volume
                            </label>
                            <input type="text" id="itemVolume" />
                        </div>
                        <div class="col s12 m4 l4">
                            <label>
                                Weight
                            </label>
                            <input type="text" id="itemWeight" />
                        </div>
                        <div class="col s12 m4 l4">
                            <label>
                                Value
                            </label>
                            <input type="text" id="itemValue" />
                        </div>
                        <div class="col s12 m4 l4">
                            <label>
                                Flat Rate (leave blank if N/A)
                            </label>
                            <input type="text" id="itemFlatrate" />
                        </div>
                        <div class="col s12 m8 l8">
                            <label>
                                Description
                            </label>
                            <input type="text" id="itemDescription" />
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn teal" onclick="saveItemSummary()">
                        Save
                    </button>
                </div>
                
            </div>
        </div>
</div>
<div>
    <input type="hidden" id="fld_destinationAccount" />
    <input type="hidden" id="fld_originAccount" />
    <input type="hidden" id="fld_destination" />
    <input type="hidden" id="fld_origin" />

</div>

<script>
    $(document).ready(function () {
        $('[data-toggle="datepicker"]').keypress(function (e) {
            e.preventDefault();
        });
        $('[data-toggle="datepicker"]').datepicker();
        loadAllWaybills();
        $('select').material_select();

        $('.modal').modal();
    });

    function filterToTbl(element, dataid)
    {

        var searchkey = $(element).val().toUpperCase().split();

        $.each($('#' + dataid + ' tbody').find('tr'), function (key, val) {
            var searchkeys = $(val).attr("searchkeys").toUpperCase()
           
            if (searchkeys.indexOf(searchkey)>-1)
            {
                $(val).show();
            } else
            {
                $(val).hide();
            }
        });
    }

    function loadAllWaybills()
    {
        $('#tbl_waybillList tbody').html("");
        OffDB.getAll(sDBName, "waybills", function (results) {
            $.each(results, function (key, result) {
                OffDB.getById(sDBName, "branches", getUserBranch(), function (content) {
                    var fromRt = content.branchshortcode;
                    OffDB.getById(sDBName, "branches", result.destination, function (content) {
                        var toRt = content.branchshortcode;
                        OffDB.getById(sDBName, "customerOrigAccounts", result.shipper, function (content) {
                            var shp = content.customerLastname + ', ' + content.customerFirstname;
                            OffDB.getById(sDBName, "customerDestinationAccounts", result.consignee, function (content) {
                                var cne = content.customerLastname + ', ' + content.customerFirstname;
                                var template = `<tr searchkeys="` + result.date + ` ` + fromRt + ` - ` + toRt + ` ` + result.trackingno + ` ` + result.waybillno + ` ` + shp + ` ` + cne + `" onclick=" loadwaybill('` + result.trackingno+`'); $('#waybillForm').fadeIn();$('#waybillList').fadeOut();">
                                               <td>
                                                   `+ result.date + `
                                               </td>
                                               <td>
                                                   `+fromRt+` - `+toRt+`
                                               </td>
                                               <td>
                                                   `+result.trackingno+`
                                               </td>
                                               <td>
                                                  `+ result.waybillno+`
                                               </td>
                                               <td>
                                                   `+shp+`
                                               </td>
                                               <td>
                                                   `+cne+`
                                               </td>
                                           </tr>`;

                                $('#tbl_waybillList tbody').html($('#tbl_waybillList tbody').html() + template);
                            });
                        });
                    });

            });


            });
        });
    }


    function loadwaybill(trackingno) {

        var originAcct;
        var destinationAcct;
        var origin;
        var destination;
        OffDB.getById(sDBName, "waybills", trackingno ,function (result) {
                OffDB.getById(sDBName, "branches", getUserBranch(), function (content) {
                    var origin = content;
                    OffDB.getById(sDBName, "branches", result.destination, function (content) {
                        var destination = content;
                        OffDB.getById(sDBName, "customerOrigAccounts", result.shipper, function (content) {
                            var originAcct = content;
                            OffDB.getById(sDBName, "customerDestinationAccounts", result.consignee, function (content) {
                                var destinationAcct = content;

                                $('#trackingno').val(trackingno);
                                $('#shipperName').html(originAcct.customerLastname+", "+originAcct.customerFirstname);
                                $('#shipperAddress').html(originAcct.customerAddress);
                                $('#shipperPhone').html(originAcct.customerPhone);
                                $('#createDate').val(result.date);
                                $('#waybillno').val(result.waybillno);
                                $('#prno').val(result.prno);
                                $('#route').val(origin.branchshortcode + " - " + destination.branchshortcode);


                                $('#pickupCharge').val(result.pickupcharge);
                                $('#weightCharge').val(result.weightcharge);
                                $('#deliveryCharge').val(result.deliverycharge);
                                $('#volumeCharge').val(result.volumecharge);
                                $('#discount').val(result.discount);
                                $('#valueCharge').val(result.valuecharge);
                                $('#adjustment').val(result.adjustment);
                                $('#flatrateCharge').val(result.flatratecharge);


                                $('#consigneeName').html(destinationAcct.customerLastname + ", " + destinationAcct.customerFirstname);
                                $('#consigneeAddress').html(destinationAcct.customerAddress);
                                $('#consigneePhone').html(destinationAcct.customerPhone);


                                    $('#fld_originAccount').val(originAcct.customerAccountNo);
                                    $('#fld_destinationAccount').val(destinationAcct.customerAccountNo);
                                    $('#fld_origin').val(origin.branchid);
                                    $('#fld_destination').val(destination.branchid);
                            });
                        });
                    });

                });
            
        });

    }

    function savewaybill() {
        var waybills = new Array();
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!

        var yyyy = today.getFullYear();
        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        var today = dd + '/' + mm + '/' + yyyy;

        var waybill = {
            trackingno: $('#trackingno').val(),
            waybillno: $('#waybillno').val(),
            prno: $('#prno').val(),
            date: $('#createDate').val(),
            pickupdate: $('#pickupDate').val(),
            delivereddate: $('#deliveredDate').val(),
            shipper: $('#fld_originAccount').val(),
            consignee: $('#fld_destinationAccount').val(),
            origin: $('#fld_origin').val(),
            destination: $('#fld_destination').val(),
            paymenttype: '1',
            rate: '1',
            computeType: '1',
            pickupcharge: $('#pickupCharge').val(),
            weightcharge: $('#weightCharge').val(),
            deliverycharge: $('#deliveryCharge').val(),
            volumecharge: $('#volumeCharge').val(),
            discount: $('#discount').val(),
            valuecharge: $('#valueCharge').val(),
            adjustment: $('#adjustment').val(),
            flatratecharge: $('#flatrateCharge').val(),
            EVAT: '0.00',
            Total: '',
            DirectVanLoad: '',
            PreparedBy: '',
            PickedupBy: '',
            ReceivedBy: '',
            CheckedBy: '',
            lastitemindex: $('#packages_count').val()
        };
        waybills.push(waybill);

        OffDB.insert(sDBName, "waybills", waybills);
        alert("Waybill successfully saved");
        $('#waybillForm').hide();
        $('#waybillList').hide();

        
    }

    function signout() {
        modLoad('main', "Account/login.html");
    }
    
    function saveItemSummary(itemsummarid)
    {
        if (itemsummarid == undefined)
        {
            itemsummarid = randomNumber();
        }

        if (f_ItemSummaryID != undefined && f_ItemSummaryID != "")
        {
            itemsummarid = f_ItemSummaryID;
        }
        
        var itemSummary ={
            ItemSummaryID: itemsummarid,
                ItemRangeStart: $('#itemRangeStart').val(),
                ItemRangeEnd: $('#itemRangeEnd').val(),
                Unit: $('#itemUnit').val(),
                Description: $('#itemDescription').val(),
                Weight: $('#itemWeight').val(),
                Length: $('#itemLength').val(),
                Width: $('#itemWidth').val(),
                Height: $('#itemHeight').val(),
                Volume: $('#itemVolume').val(),
                Value: $('#itemValue').val(),
                FlateRate: $('#itemFlatrate').val(),
                Charges: $('#itemFlatrate').val(),
                trackingno: $('#trackingno').val()
        };

        var arr = new Array();
        arr.push(itemSummary);
        OffDB.insert(sDBName, "ItemSummary", arr);
        loadItemSummaries();
        $('.modal').modal('close')
    }

    function randomNumber() {
        return pad(Math.floor(Math.random() * 20000), 5);
    }

    function pad(n, width, z) {
        z = z || '0';
        n = n + '';
        return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }


    function loadItemSummaries()
    {
        $('#summaryTbl tbody').html("");
        OffDB.getAll(sDBName, "ItemSummary", function (result) {
            $.each(result, function (key, val) {
                
                var template = `<tr>
                                    <td>
                                        <span class="new badge left" style="margin:0" data-badge-caption="Edit" onclick='loadItemSummary(`+ val.ItemSummaryID + `)'></span>
                                    </td>
                                    <td>
                                        `+val.ItemRangeStart+` - `+val.ItemRangeEnd+`
                                    </td>
                                    <td>
                                        `+ val.Description+`
                                    </td>
                                    <td>
                                        `+val.Unit+`
                                    </td>
                                    <td>
                                        `+ val.Weight +`
                                    </td>
                                    <td>
                                        `+ val.Length +`
                                    </td>
                                    <td>
                                        `+ val.Width +`
                                    </td>
                                    <td>
                                        `+ val.Height +`
                                    </td>
                                    <td>
                                       `+ val.Volume +`
                                    </td>
                                    <td>
                                        `+ val.Value +`
                                    </td>
                                    <td>
                                        `+ val.FlateRate +`
                                    </td>
                                    <td>
                                        `+ val.Charges +`
                                    </td>
                                </tr>`;
                $('#summaryTbl tbody').html($('#summaryTbl tbody').html() + template);

            });
        });
       
        
    }

    var f_ItemSummaryID;
    function loadItemSummary(ItemSummaryID) {
        f_ItemSummaryID = ItemSummaryID;

        $('#summaryTbl tbody').html("");

        OffDB.getById(sDBName, "ItemSummary", f_ItemSummaryID, function (result) {
            $('#itemRangeStart').val(result.ItemRangeStart);
            $('#itemRangeEnd').val(result.ItemRangeEnd);
            $('#itemUnit').val(result.Unit);
            $('#itemDescription').val(result.Description);
            $('#itemWeight').val(result.Weight);
            $('#itemLength').val(result.Length);
            $('#itemWidth').val(result.Width);
            $('#itemHeight').val(result.Height);
            $('#itemVolume').val(result.Volume);
            $('#itemValue').val(result.Value);
            $('#itemFlatrate').val(result.FlateRate);
            $('#itemFlatrate').val(resul.Chargest);
            $('#trackingno').val(result.trackingno);

            $('#itemSummaryForm').modal('open');
        });
    }
</script>