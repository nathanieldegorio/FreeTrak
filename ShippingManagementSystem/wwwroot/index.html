<!DOCTYPE html>
<html>

   

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            #printarea * {
                visibility: visible;
               
            }

            #printarea {
                position: absolute;
                top: 40px;
                left: 30px;
                height: 100%;
            }
        }
    </style>
   
</head>

<body>
    <div id="preprocess">

    </div>  
        <div id="qrscanmodal" class="modal">
            <div class="modal-content">
                <video id="preview"></video>
            </div>
        </div>
   


    <div id="main">
       
    </div>


    <!--Import jQuery before materialize.js-->
    <script src="Libraries/Jquery/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <script src="../../Libraries/qrjs/qrcode.min.js"></script>
    <script src="Libraries/qrjs/instascan.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            modLoad('main', "Account/login.html");

            OffDB.initializeDB();
            OffDB.insert(sDBName, "userDesignations", designations);
            OffDB.insert(sDBName, "userAccounts", users);


        });
        function alert(content, header)
        {
            if (header === undefined)
            {
                header = "Alert";
            }

            var alertHtml = `<div id="alertModal" class="modal">
                                <div class="modal-content">
                                    <h4>`+header+`</h4>
                                    <p>`+content+`</p>
                                </div>
                                <div class="modal-footer">
                                    <a class="modal-action modal-close waves-effect waves-green btn-flat">OK</a>
                                </div>
                            </div>`;

            $('#preprocess').html(alertHtml);
            $('#alertModal').modal();
            $('#alertModal').modal('open');            
        }
        function modLoad( id, url, callback, params)
        {
            $.ajax({
                url: "Views/" + url,
                data: {},
                success: function (data) {
                    $('#' + id).html(data);
                },
                dataType: "text"
            });
        }
    </script>

    <script>
         function qrlogin() {
             qrscan(function (content) {
                 var params = content.split("|");
                 login(params[0], params[1]);
             });
        }


         function login(username, password) {
             var user = OffDB.getById(sDBName, "userAccounts", username, function (content) {
                 if (content != undefined)
                 {
                     if (password == content.Password) {
                         modLoad("main", "Station/station.html");
                     } else {
                         alert("Please check username/password.", "Error on Login");
                     }
                 } else
                 {
                     alert("Please check username/password.", "Error on Login");
                 }
                 
             });
         }

    </script>


    <script>
        

        function qrscan(callback)
        {
            let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
            scanner.addListener('scan', function (content) {
                callback(content);
            });
            scanner.addListener('abort', function (content) {
               // console.log(content);
            });
            Instascan.Camera.getCameras().then(function (cameras) {
                if (cameras.length > 0) {
                    scanner.start(cameras[0]);
                } else {
                    console.error('No cameras found.');
                }
            }).catch(function (e) {
                console.error(e);
            });

            $('#qrscanmodal').modal();
            $('#qrscanmodal').modal('open');
        }
    </script>
    <script>
        //Offline DB Scripts
        var OffDB = {};
        var sDBName = "JCSDBOff";
        
        OffDB.initializeDB = function () {
            var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;

            // Open (or create) the database
            var dbGlobal = indexedDB.open(sDBName, 1);

            // Create the schema
            dbGlobal.onupgradeneeded = function () {
                dbGl = dbGlobal.result;
                dbGl.createObjectStore("userDesignations", { keyPath: "userDesignationID", unique: false });
                dbGl.createObjectStore("userAccounts", { keyPath: "Username", unique: false });
                
            };
        };
        
        OffDB.insert = function (DBName, tableName, items) {
            var dbGlobal = indexedDB.open(sDBName, 1);
            var db;
            dbGlobal.onsuccess = function (event) {
                db = event.target.result;

                var tx = db.transaction(tableName, "readwrite");
                var store = tx.objectStore(tableName);

                $.each(items, function (key, value) {
                    store.put(value);
                });

                tx.oncomplete = function () {
                    db.close();
                };

            };
        };
        
        OffDB.getById = function (DBName, tableName, id, callback) {
            var dbGlobal = indexedDB.open(DBName, 1);
            var db;
            dbGlobal.onsuccess = function (event) {
                db = event.target.result;

                var tx = db.transaction(tableName, "readwrite");
                var store = tx.objectStore(tableName);

                var items = store.get(id);

                items.onsuccess = function (event) {
                    callback(event.target.result);
                };

                tx.oncomplete = function () {
                    db.close();
                };


            };
        };
        
        OffDB.getAll = function (DBName, tableName, callback) {
            var dbGlobal = indexedDB.open(DBName, 1);
            var db;
            dbGlobal.onsuccess = function (event) {
                db = event.target.result;

                var tx = db.transaction(tableName, "readwrite");
                var store = tx.objectStore(tableName);

                var items = store.getAll();

                items.onsuccess = function (event) {
                    callback(event.target.result);
                };
                
                tx.oncomplete = function () {
                    db.close();
                };


            };
        };
    </script>
    <script>
        var designations = new Array();
        var users = new Array();

        var stationDesignation = {
            userDesignationID: '1',
            userDesignationLevel: '1',
            userDesginationName: 'station'
        };

        var encoderDesignation = {
            userDesignationID: '2',
            userDesignationLevel: '1',
            userDesginationName: 'encoder'
        };


        var receiverDesignation = {
            userDesignationID: '3',
            userDesignationLevel: '1',
            userDesginationName: 'receiver'
        };
        designations.push(stationDesignation);
        designations.push(encoderDesignation);
        designations.push(receiverDesignation);


        var stationUser = {
            Username: 'station',
            Password: 'station123',
            Lastname: 'Station',
            FirstName: 'Test User',
            UserDesignation: '1'
        };


        var encoderUser = {
            Username: 'encoder',
            Password: 'encoder123',
            Lastname: 'Encoder',
            FirstName: 'Test User',
            UserDesignation: '2'
        };

        var receiverUser = {
            Username: 'receiver',
            Password: 'receiver123',
            Lastname: 'Receiver',
            FirstName: 'Test User',
            UserDesignation: '3'
        };

        users.push(stationUser);
        users.push(encoderUser);
        users.push(receiverUser);

       
    </script>
   



</body>
</html>